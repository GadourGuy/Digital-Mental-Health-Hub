<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" th:href="@{/css/student/chatbot.css}" />
    <link rel="stylesheet" th:href="@{/css/student/student_nav.css}" />
</head>
<body>

<div class="dashboard-container">
    
    <div th:replace="fragments/Student-navbar :: navbar(activeTab='chatbot')"></div>

    <main class="main-content">
        
        <div class="page-header">
            <div class="page-title">AI Mental Health Chatbot</div>
            <div class="page-subtitle">Get instant support and guidance anytime you need it</div>
        </div>

        <div class="disclaimer-banner">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div>This AI chatbot provides supportive conversations but is not a replacement for professional mental health care. If you're experiencing a crisis, use the Emergency Button.</div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div class="bot-avatar"><i class="fa-solid fa-robot"></i></div>
                <div>
                    <div style="font-weight: bold; font-size: 14px;">Mental Health Assistant</div>
                    <div style="font-size: 12px; color: #00C950;">â€¢ Always here to listen</div>
                </div>
            </div>

            <div class="chat-messages" id="chatBox">
                <div class="message bot-message">
                    Hello! I'm here to support you. How are you feeling today?
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">Assistant is typing...</div>

            <div class="quick-topics">
                <div class="topic-pill" onclick="sendQuickMessage('I am feeling very stressed about exams')">Exam Stress</div>
                <div class="topic-pill" onclick="sendQuickMessage('I am having trouble sleeping')">Sleep Issues</div>
                <div class="topic-pill" onclick="sendQuickMessage('I feel lonely lately')">Loneliness</div>
                <div class="topic-pill" onclick="sendQuickMessage('Can you suggest a breathing exercise?')">Breathing Exercise</div>
            </div>

            <div class="input-area">
                <textarea id="messageInput" class="chat-input" placeholder="Type your message..." onkeypress="handleEnter(event)"></textarea>
                <button id="sendBtn" class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </main>
</div>

<script th:inline="javascript">
    const chatBox = document.getElementById('chatBox');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    // --- NEW: Get the correct URL including your project name ---
    const apiURL = /*[[@{/api/chat}]]*/ '/api/chat'; 

    function handleEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    function sendQuickMessage(text) {
        input.value = text;
        sendMessage();
    }

    async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        // 1. Add User Message to UI
        addMessage(text, 'user-message');
        input.value = '';
        sendBtn.disabled = true;
        typingIndicator.style.display = 'block';

        // 2. Send to Backend
        try {
            // --- UPDATED: Use the variable apiURL here ---
            const response = await fetch(apiURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            // If the server returns 404 or 403, throw an error
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // 3. Add AI Response to UI
            typingIndicator.style.display = 'none';
            addMessage(data.reply, 'bot-message');

        } catch (error) {
            console.error('Error:', error);
            typingIndicator.style.display = 'none';
            addMessage("I apologize, but I'm having trouble connecting right now. Please try again later.", 'bot-message');
        } finally {
            sendBtn.disabled = false;
        }
    }

    function addMessage(text, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight; 
    }
</script>

</body>
</html>